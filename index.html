<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Gestione Oliveto v04</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --green:#2d6a4f;--green-dark:#1a3d2b;--green-light:#d8f3dc;
  --bg:#f4f6f4;--card:#fff;--border:#e4ebe4;
  --text:#1a2e1a;--muted:#6b7c6b;--danger:#dc2626;
  --shadow:0 1px 4px rgba(0,0,0,.08);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
a{color:inherit;text-decoration:none}

/* LAYOUT */
.app{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{width:220px;background:var(--green-dark);color:#fff;display:flex;flex-direction:column;position:fixed;inset:0 auto 0 0;z-index:50}
.logo{padding:20px 18px 16px;border-bottom:1px solid rgba(255,255,255,.1)}
.logo-title{font-size:.95rem;font-weight:700;letter-spacing:.2px}
.logo-sub{font-size:.7rem;opacity:.5;margin-top:2px}
.nav{padding:8px 0;flex:1}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 18px;cursor:pointer;font-size:.85rem;font-weight:500;transition:background .15s;user-select:none;border-right:3px solid transparent}
.nav-item:hover{background:rgba(255,255,255,.07)}
.nav-item.active{background:rgba(255,255,255,.12);border-right-color:#74c69d}
.nav-ic{font-size:1rem;width:20px;text-align:center}

/* MAIN */
.main{margin-left:220px;flex:1}
.view{display:none;min-height:100vh;flex-direction:column}
.view.active{display:flex}

/* PAGE HEADER */
.ph{background:var(--card);padding:16px 26px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;box-shadow:var(--shadow)}
.ph h2{font-size:1.05rem;font-weight:700}
.pb{padding:22px 26px;flex:1}

/* STAT BAR */
.stat-bar{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.sc{background:var(--card);border-radius:10px;padding:13px 16px;box-shadow:var(--shadow);border-left:3px solid var(--green)}
.sc.blue{border-left-color:#2563eb}.sc.amber{border-left-color:#d97706}.sc.violet{border-left-color:#7c3aed}
.sc-lbl{font-size:.68rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.sc-val{font-size:1.4rem;font-weight:700;margin-top:3px}

/* CARDS */
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.card{background:var(--card);border-radius:12px;padding:17px;box-shadow:var(--shadow);border:1px solid var(--border)}
.card-name{font-size:.95rem;font-weight:700}
.card-sub{font-size:.75rem;color:var(--muted);margin-top:2px}
.metrics{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-top:13px}
.metric{background:var(--bg);border-radius:7px;padding:9px 11px}
.ml{font-size:.65rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.mv{font-size:.9rem;font-weight:700;margin-top:2px}
.interventi{margin-top:12px;border-top:1px solid var(--border);padding-top:10px;display:flex;flex-direction:column;gap:2px}
.irow{display:flex;justify-content:space-between;font-size:.78rem;padding:3px 0}
.ilbl{color:var(--muted)}
.idate{font-weight:600}
.ok{color:#16a34a}.warn{color:#d97706}.old{color:var(--danger)}.na{color:#aaa}

/* TABLE */
.tw{background:var(--card);border-radius:12px;box-shadow:var(--shadow);overflow:hidden;border:1px solid var(--border)}
.tb-bar{padding:12px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);flex-wrap:wrap}
table{width:100%;border-collapse:collapse}
th{background:var(--bg);padding:9px 13px;text-align:left;font-size:.68rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);white-space:nowrap}
td{padding:10px 13px;font-size:.84rem;border-bottom:1px solid var(--border);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:#fbfdfb}
.act{display:flex;gap:4px}

/* BADGE */
.badge{padding:2px 8px;border-radius:20px;font-size:.7rem;font-weight:600;white-space:nowrap}
.bg{background:#d1fae5;color:#065f46}.br{background:#fee2e2;color:#991b1b}
.by{background:#fef9c3;color:#854d0e}.bb{background:#dbeafe;color:#1e40af}.bgr{background:#f1f5f9;color:#475569}

/* BUTTONS */
.btn{padding:7px 14px;border-radius:8px;border:none;cursor:pointer;font-size:.83rem;font-weight:600;transition:all .15s;font-family:'Inter',sans-serif}
.btn-p{background:var(--green);color:#fff}.btn-p:hover{background:var(--green-dark)}
.btn-s{background:var(--bg);color:var(--text);border:1px solid var(--border)}.btn-s:hover{background:var(--border)}
.btn-ic{padding:4px 7px;background:transparent;border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:.85rem;line-height:1;transition:background .15s}
.btn-ic:hover{background:var(--bg)}

/* INPUTS */
.fg{margin-bottom:13px}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:13px}
label{display:block;font-size:.75rem;font-weight:600;color:var(--muted);margin-bottom:4px}
input,select,textarea{border:1px solid var(--border);border-radius:7px;padding:7px 10px;font-size:.84rem;font-family:'Inter',sans-serif;width:100%;color:var(--text);background:#fff;transition:border .15s}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--green);box-shadow:0 0 0 3px rgba(45,106,79,.1)}
input[readonly]{background:var(--bg)}
.fb{display:flex;gap:8px;align-items:center;flex:1;flex-wrap:wrap}
.fb select{max-width:180px}
.tot-lbl{font-weight:700;color:var(--green);margin-left:auto;font-size:.85rem}

/* MODAL */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:100}
.ov.open{display:flex}
.modal{background:#fff;border-radius:14px;width:500px;max-width:96vw;max-height:93vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.mh{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;z-index:1}
.mh h3{font-size:.9rem;font-weight:700}
.mb{padding:20px}
.mf{padding:13px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}

/* MISC */
.spin-wrap{display:flex;align-items:center;justify-content:center;padding:50px;color:var(--muted)}
.spinner{width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin .8s linear infinite;margin-right:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:45px 20px;color:var(--muted)}
.empty-ic{font-size:2.2rem}
.empty p{margin-top:8px;font-size:.88rem}
.toast{position:fixed;bottom:20px;right:20px;background:var(--green-dark);color:#fff;padding:10px 16px;border-radius:8px;font-size:.84rem;font-weight:500;z-index:200;opacity:0;transform:translateY(10px);transition:all .25s;pointer-events:none}
.toast.show{opacity:1;transform:translateY(0)}

/* OVERVIEW CHARTS */
.ov-charts{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.chart-box{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);border:1px solid var(--border)}
.chart-box h4{font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:14px}
.pie-wrap{display:flex;gap:18px;align-items:center}
.pie-wrap canvas{flex-shrink:0}
.pie-legend{display:flex;flex-direction:column;gap:6px;flex:1;min-width:0}
.pie-leg-it{display:flex;align-items:center;gap:6px;font-size:.73rem}
.pie-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.pie-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text)}
.pie-pct{font-weight:700;width:30px;text-align:right}
.pie-eur{color:var(--muted);width:68px;text-align:right}
.harv-box{display:flex;flex-direction:column;gap:12px}
.harv-totals{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.harv-stat{background:var(--bg);border-radius:8px;padding:10px 13px}
.harv-lbl{font-size:.65rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.harv-val{font-size:1.05rem;font-weight:700;margin-top:3px}
.harv-mini{display:flex;flex-direction:column;gap:5px;margin-top:2px}
.harv-row{display:flex;align-items:center;gap:8px;font-size:.74rem}
.harv-campo{width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--muted)}
.harv-bar-wrap{flex:1;background:var(--bg);border-radius:20px;height:6px;overflow:hidden}
.harv-bar{height:100%;border-radius:20px;transition:width .5s ease}
.harv-kg{width:55px;text-align:right;font-weight:600}

/* APPUNTI CAMPO */
.ap-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.ap-card{background:var(--card);border-radius:12px;overflow:hidden;box-shadow:var(--shadow);border:1px solid var(--border)}
.ap-photo{width:100%;height:190px;object-fit:cover;display:block;background:var(--bg)}
.ap-photo-ph{height:100px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:2.5rem;color:#ccc}
.ap-body{padding:13px}
.ap-meta{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px}
.ap-campo{font-size:.85rem;font-weight:700}
.ap-date{font-size:.7rem;color:var(--muted)}
.ap-text{font-size:.82rem;line-height:1.55;margin-bottom:9px;color:var(--text);white-space:pre-wrap}
.ap-gps{display:block;font-size:.7rem;color:#3b82f6;margin-bottom:8px}
.ap-foot{display:flex;justify-content:flex-end;border-top:1px solid var(--border);padding-top:8px}
/* CAPTURE MODAL */
.cap-photo-area{border:2px dashed var(--border);border-radius:10px;overflow:hidden;cursor:pointer;min-height:110px;display:flex;align-items:center;justify-content:center;background:var(--bg);margin-bottom:8px}
.cap-photo-area img{width:100%;max-height:220px;object-fit:cover;display:block}
.cap-photo-ph{display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);padding:22px;pointer-events:none}
.cap-photo-ph span{font-size:2.2rem}.cap-photo-ph p{font-size:.78rem}
.cap-gps-row{font-size:.74rem;margin-bottom:12px;min-height:18px}
.mic-btn{width:100%;padding:13px;border:1px solid var(--border);border-radius:10px;background:var(--bg);cursor:pointer;font-size:.84rem;font-weight:600;font-family:'Inter',sans-serif;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;margin-bottom:10px}
.mic-btn.recording{background:#fee2e2;border-color:#ef4444;color:#dc2626;animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}

/* TAB BAR (dentro Campi) */
.tab-bar{display:flex;background:var(--card);border-bottom:1px solid var(--border);padding:0 20px}
.tab{padding:11px 16px;font-size:.83rem;font-weight:600;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all .15s;user-select:none}
.tab.active{color:var(--green);border-bottom-color:var(--green)}
.tab:hover:not(.active){color:var(--text)}

/* HAMBURGER BUTTON (mobile only) */
.hamburger-btn{display:none;position:fixed;top:11px;left:11px;z-index:61;background:var(--green-dark);color:#fff;border:none;border-radius:8px;width:38px;height:38px;font-size:1.15rem;cursor:pointer;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.25)}
/* NAV OVERLAY (mobile) */
.nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:59}
.nav-overlay.open{display:block}

/* ===================================================
   RESPONSIVE ‚Äî iPhone / mobile (max 768px)
   =================================================== */
@media (max-width:768px){
  /* Sidebar: nascosta, slide-in */
  .sidebar{transform:translateX(-100%);transition:transform .26s ease;z-index:60}
  .sidebar.open{transform:translateX(0)}
  .hamburger-btn{display:flex}
  /* Main occupa tutto */
  .main{margin-left:0}
  /* Header: spazio per hamburger */
  .ph{padding:13px 14px 13px 56px}
  .pb{padding:14px 14px;padding-bottom:calc(14px + env(safe-area-inset-bottom))}
  /* Sidebar safe area bottom */
  .sidebar{padding-bottom:env(safe-area-inset-bottom)}
  /* Stats: 2 colonne */
  .stat-bar{grid-template-columns:1fr 1fr;gap:10px}
  .sc-val{font-size:1.15rem}
  /* Charts: 1 colonna */
  .ov-charts{grid-template-columns:1fr}
  /* Pie: verticale */
  .pie-wrap{flex-direction:column;align-items:center;gap:14px}
  /* Harvest totals: 1 colonna */
  .harv-totals{grid-template-columns:1fr}
  /* Cards grids: 1 colonna */
  .cards-grid{grid-template-columns:1fr}
  .ap-grid{grid-template-columns:1fr}
  /* Tabelle scrollabili */
  .tw{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .tw table{min-width:560px}
  /* Form 2-col ‚Üí 1-col */
  .fr{grid-template-columns:1fr;gap:0}
  /* Filtri full width */
  .fb{flex-direction:column;align-items:stretch}
  .fb select{max-width:100%}
  /* Modali: bottom sheet */
  .ov{align-items:flex-end;padding:0}
  .modal{width:100%;max-width:100%;border-radius:18px 18px 0 0;max-height:92vh}
  .modal::before{content:'';display:block;width:38px;height:4px;background:#ddd;border-radius:2px;margin:10px auto 0}
  .mh{padding-top:8px}
  /* Touch target bottoni tabella */
  .btn-ic{padding:7px 10px;font-size:.95rem}
  .btn{padding:9px 16px}
  /* Voce mic button */
  .mic-btn{padding:16px;font-size:.9rem}
}
</style>
</head>
<body>
<button class="hamburger-btn" id="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button>
<div id="nav-overlay" class="nav-overlay" onclick="closeSidebar()"></div>

<div class="app">

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="logo">
    <div class="logo-title">Gestione Oliveto</div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:3px">
      <div class="logo-sub">Pannello di controllo</div>
      <div style="font-size:.62rem;font-weight:700;background:rgba(255,255,255,.15);padding:1px 6px;border-radius:4px;opacity:.8">v04</div>
    </div>
  </div>
  <div class="nav">
    <div class="nav-item active" data-view="overview"><span class="nav-ic">üìä</span>Overview</div>
    <div class="nav-item" data-view="campi"><span class="nav-ic">üó∫Ô∏è</span>Campi</div>
    <div class="nav-item" data-view="lavorazioni"><span class="nav-ic">üåø</span>Lavorazioni</div>
    <div class="nav-item" data-view="costi"><span class="nav-ic">üí∞</span>Costi</div>
    <div class="nav-item" data-view="raccolta"><span class="nav-ic">ü´ô</span>Raccolta</div>
    <div class="nav-item" data-view="entrate"><span class="nav-ic">üí∂</span>PAC / Biologico</div>
  </div>
</nav>

<main class="main">

<!-- OVERVIEW -->
<div id="view-overview" class="view active">
  <div class="ph"><h2>Overview</h2><button class="btn btn-s" onclick="loadOverview()">‚Ü∫ Aggiorna</button></div>
  <div class="pb">
    <div class="stat-bar" id="ov-stats"></div>
    <div id="ov-charts"></div>
    <div class="cards-grid" id="ov-cards"><div class="spin-wrap"><div class="spinner"></div>Caricamento...</div></div>
  </div>
</div>

<!-- CAMPI + DIARI (tab) -->
<div id="view-campi" class="view">
  <div class="ph">
    <h2>Campi</h2>
    <div style="display:flex;gap:8px">
      <button id="btn-nuovo-campo" class="btn btn-p" onclick="openCampoModal()">+ Nuovo Campo</button>
      <button id="btn-nuovo-appunto" class="btn btn-p" style="display:none" onclick="openCapture()">üì∑ Appunto</button>
    </div>
  </div>
  <div class="tab-bar">
    <div class="tab active" id="tab-campi" onclick="switchCampiTab('campi')">üó∫Ô∏è Lista Campi</div>
    <div class="tab" id="tab-diari" onclick="switchCampiTab('diari')">üì∑ Diari</div>
  </div>
  <div class="pb">
    <div id="campi-section">
      <div class="tw">
        <table><thead><tr><th>Nome</th><th>Ettari</th><th>N. Piante</th><th>Variet√†</th><th>Anno</th><th>Comune</th><th>Note</th><th></th></tr></thead>
        <tbody id="campi-tb"><tr><td colspan="8"><div class="spin-wrap"><div class="spinner"></div></div></td></tr></tbody></table>
      </div>
    </div>
    <div id="diari-section" style="display:none">
      <div style="margin-bottom:16px">
        <select id="apf-campo" onchange="renderAppunti()" style="max-width:220px"><option value="">Tutti i campi</option></select>
      </div>
      <div class="ap-grid" id="ap-grid"></div>
    </div>
  </div>
</div>

<!-- LAVORAZIONI -->
<div id="view-lavorazioni" class="view">
  <div class="ph"><h2>Lavorazioni</h2><button class="btn btn-p" onclick="openLavModal()">+ Nuova Lavorazione</button></div>
  <div class="pb"><div class="tw">
    <div class="tb-bar">
      <div class="fb">
        <select id="lf-campo" onchange="renderLav()"><option value="">Tutti i campi</option></select>
        <select id="lf-tipo" onchange="renderLav()"><option value="">Tutti i tipi</option>
          <option>Potatura</option><option>Trattamento Fitosanitario</option>
          <option>Concimazione</option><option>Raccolta</option><option>Altra Lavorazione</option></select>
      </div>
    </div>
    <table><thead><tr><th>Data</th><th>Campo</th><th>Tipo</th><th>Descrizione</th><th>Prodotto</th><th>Operatore</th><th>Costo</th><th></th></tr></thead>
    <tbody id="lav-tb"></tbody></table>
  </div></div>
</div>

<!-- COSTI -->
<div id="view-costi" class="view">
  <div class="ph"><h2>Costi</h2><button class="btn btn-p" onclick="openCostoModal()">+ Nuovo Costo</button></div>
  <div class="pb"><div class="tw">
    <div class="tb-bar">
      <div class="fb">
        <select id="cf-campo" onchange="renderCosti()"><option value="">Tutti i campi</option></select>
        <select id="cf-cat" onchange="renderCosti()"><option value="">Tutte le categorie</option>
          <option>Prodotti Fitosanitari</option><option>Concimi / Fertilizzanti</option>
          <option>Carburante</option><option>Manodopera</option>
          <option>Affitto</option><option>Macchinari / Attrezzature</option><option>Altro</option></select>
      </div>
      <span class="tot-lbl" id="costi-tot"></span>
    </div>
    <table><thead><tr><th>Data</th><th>Campo</th><th>Categoria</th><th>Descrizione</th><th>Qt√†</th><th>Costo Unit.</th><th>Totale</th><th>Fornitore</th><th></th></tr></thead>
    <tbody id="costi-tb"></tbody></table>
  </div></div>
</div>

<!-- ENTRATE PAC / BIOLOGICO -->
<div id="view-entrate" class="view">
  <div class="ph"><h2>PAC / Biologico</h2><button class="btn btn-p" onclick="openEntrataModal()">+ Nuova Entrata</button></div>
  <div class="pb"><div class="tw">
    <div class="tb-bar">
      <div class="fb">
        <select id="ef-anno" onchange="renderEntrate()"><option value="">Tutti gli anni</option></select>
        <select id="ef-tipo" onchange="renderEntrate()"><option value="">Tutti i tipi</option>
          <option>PAC</option><option>Biologico</option><option>Altro</option></select>
      </div>
      <span class="tot-lbl" id="entrate-tot"></span>
    </div>
    <table><thead><tr><th>Anno</th><th>Campo</th><th>Tipo</th><th>Descrizione</th><th>Importo</th><th>Note</th><th></th></tr></thead>
    <tbody id="entrate-tb"></tbody></table>
  </div></div>
</div>

<!-- RACCOLTA -->
<div id="view-raccolta" class="view">
  <div class="ph"><h2>Raccolta</h2><button class="btn btn-p" onclick="openRaccModal()">+ Nuova Raccolta</button></div>
  <div class="pb"><div class="tw">
    <div class="tb-bar"><div class="fb">
      <select id="rf-campo" onchange="renderRacc()"><option value="">Tutti i campi</option></select>
    </div></div>
    <table><thead><tr><th>Anno</th><th>Campo</th><th>Inizio</th><th>Fine</th><th>KG</th><th>KG/Ha</th><th>Destinazione</th><th>Note</th><th></th></tr></thead>
    <tbody id="racc-tb"></tbody></table>
  </div></div>
</div>

</main>
</div>

<!-- MODAL CAMPO -->
<div id="m-campo" class="ov">
  <div class="modal">
    <div class="mh"><h3 id="mc-title">Nuovo Campo</h3><button class="btn-ic" onclick="cm('m-campo')">‚úï</button></div>
    <div class="mb">
      <input type="hidden" id="c-id">
      <div class="fr"><div class="fg"><label>Nome Campo *</label><input id="c-nome" placeholder="es. Campo di Sopra"></div>
      <div class="fg"><label>Comune / Localit√†</label><input id="c-comune" placeholder="es. Trevi"></div></div>
      <div class="fr"><div class="fg"><label>Ettari</label><input id="c-ettari" type="number" step="0.01" placeholder="es. 1.5"></div>
      <div class="fg"><label>N. Piante</label><input id="c-piante" type="number" placeholder="es. 120"></div></div>
      <div class="fr"><div class="fg"><label>Variet√† Olivo</label><input id="c-varieta" placeholder="es. Frantoio, Leccino"></div>
      <div class="fg"><label>Anno Impianto</label><input id="c-anno" type="number" placeholder="es. 1985"></div></div>
      <div class="fg"><label>Note</label><textarea id="c-note" rows="2" placeholder="Note aggiuntive..."></textarea></div>
    </div>
    <div class="mf"><button class="btn btn-s" onclick="cm('m-campo')">Annulla</button><button class="btn btn-p" onclick="saveCampo()">Salva</button></div>
  </div>
</div>

<!-- MODAL LAVORAZIONE -->
<div id="m-lav" class="ov">
  <div class="modal">
    <div class="mh"><h3 id="ml-title">Nuova Lavorazione</h3><button class="btn-ic" onclick="cm('m-lav')">‚úï</button></div>
    <div class="mb">
      <input type="hidden" id="l-id">
      <div class="fr"><div class="fg"><label>Data *</label><input id="l-data" type="date"></div>
      <div class="fg"><label>Campo *</label><select id="l-campo"></select></div></div>
      <div class="fg"><label>Tipo Operazione *</label>
        <select id="l-tipo"><option value="">Seleziona...</option>
          <option>Potatura</option><option>Trattamento Fitosanitario</option>
          <option>Concimazione</option><option>Raccolta</option><option>Altra Lavorazione</option></select></div>
      <div class="fg"><label>Descrizione / Note</label><textarea id="l-desc" rows="2" placeholder="Dettagli..."></textarea></div>
      <div class="fr"><div class="fg"><label>Prodotto Usato</label><input id="l-prod" placeholder="es. Rame, Azoto..."></div>
      <div class="fg"><label>Operatore</label><input id="l-oper" placeholder="Nome operatore"></div></div>
      <div class="fr"><div class="fg"><label>Quantit√†</label><input id="l-qta" type="number" step="0.01"></div>
      <div class="fg"><label>Unit√†</label><input id="l-un" placeholder="es. L, kg, ore"></div></div>
      <div class="fg"><label>Costo ‚Ç¨</label><input id="l-costo" type="number" step="0.01" placeholder="0.00"></div>
    </div>
    <div class="mf"><button class="btn btn-s" onclick="cm('m-lav')">Annulla</button><button class="btn btn-p" onclick="saveLav()">Salva</button></div>
  </div>
</div>

<!-- MODAL COSTO -->
<div id="m-costo" class="ov">
  <div class="modal">
    <div class="mh"><h3 id="mco-title">Nuovo Costo</h3><button class="btn-ic" onclick="cm('m-costo')">‚úï</button></div>
    <div class="mb">
      <input type="hidden" id="co-id">
      <div class="fr"><div class="fg"><label>Data *</label><input id="co-data" type="date"></div>
      <div class="fg"><label>Campo *</label><select id="co-campo"></select></div></div>
      <div class="fg"><label>Categoria *</label>
        <select id="co-cat"><option value="">Seleziona...</option>
          <option>Prodotti Fitosanitari</option><option>Concimi / Fertilizzanti</option>
          <option>Carburante</option><option>Manodopera</option>
          <option>Affitto</option><option>Macchinari / Attrezzature</option><option>Altro</option></select></div>
      <div class="fg"><label>Descrizione</label><input id="co-desc" placeholder="Descrizione spesa..."></div>
      <div class="fr"><div class="fg"><label>Quantit√†</label><input id="co-qta" type="number" step="0.01" oninput="calcTot()"></div>
      <div class="fg"><label>Unit√†</label><input id="co-un" placeholder="es. L, kg, ore"></div></div>
      <div class="fr"><div class="fg"><label>Costo Unitario ‚Ç¨</label><input id="co-unit" type="number" step="0.01" oninput="calcTot()"></div>
      <div class="fg"><label>Totale ‚Ç¨</label><input id="co-tot" type="number" step="0.01" readonly></div></div>
      <div class="fr"><div class="fg"><label>Fornitore</label><input id="co-forn" placeholder="Nome fornitore"></div>
      <div class="fg"><label>Note</label><input id="co-note" placeholder="Note..."></div></div>
    </div>
    <div class="mf"><button class="btn btn-s" onclick="cm('m-costo')">Annulla</button><button class="btn btn-p" onclick="saveCosto()">Salva</button></div>
  </div>
</div>

<!-- MODAL RACCOLTA -->
<div id="m-racc" class="ov">
  <div class="modal">
    <div class="mh"><h3 id="mr-title">Nuova Raccolta</h3><button class="btn-ic" onclick="cm('m-racc')">‚úï</button></div>
    <div class="mb">
      <input type="hidden" id="r-id">
      <div class="fr"><div class="fg"><label>Anno *</label><input id="r-anno" type="number" placeholder="es. 2025"></div>
      <div class="fg"><label>Campo *</label><select id="r-campo"></select></div></div>
      <div class="fr"><div class="fg"><label>Data Inizio</label><input id="r-ini" type="date"></div>
      <div class="fg"><label>Data Fine</label><input id="r-fin" type="date"></div></div>
      <div class="fr"><div class="fg"><label>KG Raccolti</label><input id="r-kg" type="number" step="0.1"></div>
      <div class="fg"><label>KG / Ha</label><input id="r-kgha" type="number" step="0.1"></div></div>
      <div class="fg"><label>Destinazione</label><input id="r-dest" placeholder="es. Frantoio Rossi, autoconsumo..."></div>
      <div class="fg"><label>Note</label><textarea id="r-note" rows="2" placeholder="Note..."></textarea></div>
    </div>
    <div class="mf"><button class="btn btn-s" onclick="cm('m-racc')">Annulla</button><button class="btn btn-p" onclick="saveRacc()">Salva</button></div>
  </div>
</div>

<!-- MODAL APPUNTO CAMPO -->
<div id="m-appunto" class="ov">
  <div class="modal">
    <div class="mh"><h3>Nuovo Appunto</h3><button class="btn-ic" onclick="closeCapture()">‚úï</button></div>
    <div class="mb">
      <div class="fg"><label>Campo *</label><select id="ap-campo"><option value="">Seleziona campo...</option></select></div>
      <label style="font-size:.75rem;font-weight:600;color:var(--muted);margin-bottom:6px;display:block">Foto</label>
      <div class="cap-photo-area" onclick="document.getElementById('ap-file').click()">
        <img id="ap-photo-preview" style="display:none" alt="anteprima">
        <div id="ap-photo-placeholder" class="cap-photo-ph"><span>üì∑</span><p>Tocca per scattare / scegliere foto</p></div>
      </div>
      <input type="file" id="ap-file" accept="image/*" capture="environment" style="display:none" onchange="onPhotoSelected(this)">
      <div class="cap-gps-row" id="ap-gps-info" style="color:var(--muted)">üìç Acquisendo posizione...</div>
      <label style="font-size:.75rem;font-weight:600;color:var(--muted);margin-bottom:6px;display:block">Voce ‚Üí Testo</label>
      <button type="button" class="mic-btn" id="mic-btn" onclick="toggleVoice()">üéôÔ∏è Tocca per dettare</button>
      <div class="fg"><label>Testo / Appunto</label><textarea id="ap-testo" rows="4" placeholder="Scrivi o detta l'appunto..."></textarea></div>
    </div>
    <div class="mf"><button class="btn btn-s" onclick="closeCapture()">Annulla</button><button class="btn btn-p" id="ap-save-btn" onclick="saveAppunto()">Salva</button></div>
  </div>
</div>

<!-- MODAL ENTRATA -->
<div id="m-entrata" class="ov">
  <div class="modal">
    <div class="mh"><h3 id="me-title">Nuova Entrata</h3><button class="btn-ic" onclick="cm('m-entrata')">‚úï</button></div>
    <div class="mb">
      <input type="hidden" id="e-id">
      <div class="fr"><div class="fg"><label>Anno *</label><input id="e-anno" type="number" placeholder="es. 2025"></div>
      <div class="fg"><label>Campo</label><select id="e-campo"></select></div></div>
      <div class="fg"><label>Tipo *</label>
        <select id="e-tipo"><option value="">Seleziona...</option>
          <option>PAC</option><option>Biologico</option><option>Altro</option></select></div>
      <div class="fg"><label>Descrizione</label><input id="e-desc" placeholder="es. Contributo PAC 2025, Premio bio..."></div>
      <div class="fg"><label>Importo ‚Ç¨</label><input id="e-importo" type="number" step="0.01" placeholder="0.00"></div>
      <div class="fg"><label>Note</label><textarea id="e-note" rows="2" placeholder="Note..."></textarea></div>
    </div>
    <div class="mf"><button class="btn btn-s" onclick="cm('m-entrata')">Annulla</button><button class="btn btn-p" onclick="saveEntrata()">Salva</button></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
// ============================================================
// CONFIG
// ============================================================
const VERSION = 'v04';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxzuyO-9JOAiKyx3zwOidpFV0L1Gpse5NoEO1ZGFigPprow18Xeb4qq8cWR6GmvqkzbPA/exec';
const TOKEN   = 'oliveto_gall_2025';

// ============================================================
// API
// ============================================================
async function api(action, params = {}) {
  const url = new URL(GAS_URL);
  url.searchParams.set('action', action);
  url.searchParams.set('token', TOKEN);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, typeof v === 'object' ? JSON.stringify(v) : v));
  try {
    const res = await fetch(url.toString());
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    return data;
  } catch(e) { toast('Errore: ' + e.message); throw e; }
}

// ============================================================
// STATE
// ============================================================
const S = { campi:[], lav:[], costi:[], racc:[], entrate:[], appunti:[] };

// ============================================================
// INIT & NAV
// ============================================================
window.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.nav-item').forEach(el => {
    el.addEventListener('click', () => {
      document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
      document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('view-'+el.dataset.view).classList.add('active');
      ({overview:loadOverview, campi:loadCampi, lavorazioni:loadLav, costi:loadCosti, raccolta:loadRacc, entrate:loadEntrate})[el.dataset.view]?.();
      closeSidebar();
    });
  });
  document.querySelectorAll('.ov').forEach(o => o.addEventListener('click', e => { if(e.target===o) o.classList.remove('open'); }));
  loadCampi();
  loadOverview();
});

// ============================================================
// CAMPI + TAB DIARI
// ============================================================
function switchCampiTab(tab) {
  const isDiari = tab === 'diari';
  document.getElementById('campi-section').style.display = isDiari ? 'none' : '';
  document.getElementById('diari-section').style.display = isDiari ? '' : 'none';
  document.getElementById('tab-campi').classList.toggle('active', !isDiari);
  document.getElementById('tab-diari').classList.toggle('active', isDiari);
  document.getElementById('btn-nuovo-campo').style.display = isDiari ? 'none' : '';
  document.getElementById('btn-nuovo-appunto').style.display = isDiari ? '' : 'none';
  if (isDiari) {
    if (!S.appunti.length) loadAppunti();
    else renderAppunti();
  }
}

async function loadCampi() {
  S.campi = await api('getCampi');
  renderCampi();
  updateSelects();
}

function renderCampi() {
  const tb = document.getElementById('campi-tb');
  if (!S.campi.length) { tb.innerHTML = er(8,'üó∫Ô∏è','Nessun campo. Aggiungine uno!'); return; }
  tb.innerHTML = S.campi.map(c=>`<tr>
    <td><strong>${c.nome}</strong></td><td>${c.ettari||'‚Äî'}</td><td>${c.numPiante||'‚Äî'}</td>
    <td>${c.varieta||'‚Äî'}</td><td>${c.annoImpianto||'‚Äî'}</td><td>${c.comune||'‚Äî'}</td>
    <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.note||'‚Äî'}</td>
    <td><div class="act">
      <button class="btn-ic" onclick="editCampo(${c.id})">‚úèÔ∏è</button>
      <button class="btn-ic" onclick="delCampo(${c.id},'${esc(c.nome)}')">üóëÔ∏è</button>
    </div></td></tr>`).join('');
}

function openCampoModal(c) {
  sv({'c-id':c?.id||'','c-nome':c?.nome||'','c-comune':c?.comune||'','c-ettari':c?.ettari||'',
    'c-piante':c?.numPiante||'','c-varieta':c?.varieta||'','c-anno':c?.annoImpianto||'','c-note':c?.note||''});
  document.getElementById('mc-title').textContent = c ? 'Modifica Campo' : 'Nuovo Campo';
  om('m-campo');
}
function editCampo(id) { openCampoModal(S.campi.find(c=>c.id===id)); }

async function saveCampo() {
  const nome = gv('c-nome').trim();
  if (!nome) { toast('Inserisci il nome del campo'); return; }
  await api('saveCampo', { data: { id:gv('c-id')?+gv('c-id'):null, nome, ettari:gv('c-ettari'),
    numPiante:gv('c-piante'), varieta:gv('c-varieta'), annoImpianto:gv('c-anno'),
    comune:gv('c-comune'), note:gv('c-note') }});
  cm('m-campo'); loadCampi(); toast('Campo salvato!');
}

async function delCampo(id, nome) {
  if (!confirm(`Eliminare "${nome}"?`)) return;
  await api('deleteCampo', { rowId: id });
  loadCampi(); toast('Campo eliminato');
}

// ============================================================
// LAVORAZIONI
// ============================================================
async function loadLav() {
  S.lav = await api('getLavorazioni');
  renderLav();
}

function renderLav() {
  const tb = document.getElementById('lav-tb');
  const fc = gv('lf-campo'), ft = gv('lf-tipo');
  let d = S.lav.filter(l=>(!fc||l.campo===fc)&&(!ft||l.tipo===ft)).sort((a,b)=>new Date(b.data)-new Date(a.data));
  if (!d.length) { tb.innerHTML = er(8,'üåø','Nessuna lavorazione.'); return; }
  tb.innerHTML = d.map(l=>`<tr>
    <td>${fd(l.data)}</td><td>${l.campo}</td>
    <td><span class="badge ${lb(l.tipo)}">${l.tipo}</span></td>
    <td style="max-width:180px">${l.descrizione||'‚Äî'}</td>
    <td>${l.prodotto||'‚Äî'}</td><td>${l.operatore||'‚Äî'}</td>
    <td>${l.costo?fe(l.costo):'‚Äî'}</td>
    <td><div class="act"><button class="btn-ic" onclick="editLav(${l.id})">‚úèÔ∏è</button><button class="btn-ic" onclick="delLav(${l.id})">üóëÔ∏è</button></div></td></tr>`).join('');
}

function lb(t){return{Potatura:'bg','Trattamento Fitosanitario':'br',Concimazione:'by',Raccolta:'bb','Altra Lavorazione':'bgr'}[t]||'bgr';}

function openLavModal(l) {
  sv({'l-id':l?.id||'','l-data':l?.data||today(),'l-campo':l?.campo||'','l-tipo':l?.tipo||'',
    'l-desc':l?.descrizione||'','l-prod':l?.prodotto||'','l-oper':l?.operatore||'',
    'l-qta':l?.quantita||'','l-un':l?.unita||'','l-costo':l?.costo||''});
  document.getElementById('ml-title').textContent = l ? 'Modifica Lavorazione' : 'Nuova Lavorazione';
  om('m-lav');
}
function editLav(id) { openLavModal(S.lav.find(l=>l.id===id)); }

async function saveLav() {
  if (!gv('l-data')||!gv('l-campo')||!gv('l-tipo')) { toast('Compila i campi obbligatori'); return; }
  await api('saveLavorazione', { data: { id:gv('l-id')?+gv('l-id'):null, data:gv('l-data'), campo:gv('l-campo'),
    tipo:gv('l-tipo'), descrizione:gv('l-desc'), prodotto:gv('l-prod'),
    quantita:gv('l-qta'), unita:gv('l-un'), operatore:gv('l-oper'), costo:gv('l-costo') }});
  cm('m-lav'); loadLav(); toast('Lavorazione salvata!');
}

async function delLav(id) {
  if (!confirm('Eliminare questa lavorazione?')) return;
  await api('deleteLavorazione', { rowId: id });
  loadLav(); toast('Eliminata');
}

// ============================================================
// COSTI
// ============================================================
async function loadCosti() {
  S.costi = await api('getCosti');
  renderCosti();
}

function renderCosti() {
  const tb = document.getElementById('costi-tb');
  const fc = gv('cf-campo'), fcat = gv('cf-cat');
  let d = S.costi.filter(c=>(!fc||c.campo===fc)&&(!fcat||c.categoria===fcat)).sort((a,b)=>new Date(b.data)-new Date(a.data));
  const tot = d.reduce((s,c)=>s+(parseFloat(c.totale)||0),0);
  document.getElementById('costi-tot').textContent = d.length ? 'Totale: '+fe(tot) : '';
  if (!d.length) { tb.innerHTML = er(9,'üí∞','Nessun costo registrato.'); return; }
  tb.innerHTML = d.map(c=>`<tr>
    <td>${fd(c.data)}</td><td>${c.campo}</td><td>${c.categoria}</td>
    <td>${c.descrizione||'‚Äî'}</td><td>${c.quantita||'‚Äî'}${c.unita?' '+c.unita:''}</td>
    <td>${c.costoUnitario?fe(c.costoUnitario):'‚Äî'}</td><td><strong>${c.totale?fe(c.totale):'‚Äî'}</strong></td>
    <td>${c.fornitore||'‚Äî'}</td>
    <td><div class="act"><button class="btn-ic" onclick="editCosto(${c.id})">‚úèÔ∏è</button><button class="btn-ic" onclick="delCosto(${c.id})">üóëÔ∏è</button></div></td></tr>`).join('');
}

function calcTot(){
  const q=parseFloat(gv('co-qta'))||0, u=parseFloat(gv('co-unit'))||0;
  document.getElementById('co-tot').value=(q*u).toFixed(2);
}

function openCostoModal(c) {
  sv({'co-id':c?.id||'','co-data':c?.data||today(),'co-campo':c?.campo||'','co-cat':c?.categoria||'',
    'co-desc':c?.descrizione||'','co-qta':c?.quantita||'','co-un':c?.unita||'',
    'co-unit':c?.costoUnitario||'','co-tot':c?.totale||'','co-forn':c?.fornitore||'','co-note':c?.note||''});
  document.getElementById('mco-title').textContent = c ? 'Modifica Costo' : 'Nuovo Costo';
  om('m-costo');
}
function editCosto(id) { openCostoModal(S.costi.find(c=>c.id===id)); }

async function saveCosto() {
  if (!gv('co-data')||!gv('co-campo')||!gv('co-cat')) { toast('Compila i campi obbligatori'); return; }
  await api('saveCosto', { data: { id:gv('co-id')?+gv('co-id'):null, data:gv('co-data'), campo:gv('co-campo'),
    categoria:gv('co-cat'), descrizione:gv('co-desc'), quantita:gv('co-qta'),
    unita:gv('co-un'), costoUnitario:gv('co-unit'), totale:gv('co-tot'),
    fornitore:gv('co-forn'), note:gv('co-note') }});
  cm('m-costo'); loadCosti(); toast('Costo salvato!');
}

async function delCosto(id) {
  if (!confirm('Eliminare questo costo?')) return;
  await api('deleteCosto', { rowId: id });
  loadCosti(); toast('Eliminato');
}

// ============================================================
// RACCOLTA
// ============================================================
async function loadRacc() {
  S.racc = await api('getRaccolte');
  renderRacc();
}

function renderRacc() {
  const tb = document.getElementById('racc-tb');
  const fc = gv('rf-campo');
  let d = S.racc.filter(r=>!fc||r.campo===fc).sort((a,b)=>b.anno-a.anno);
  if (!d.length) { tb.innerHTML = er(9,'ü´ô','Nessuna raccolta registrata.'); return; }
  tb.innerHTML = d.map(r=>`<tr>
    <td><strong>${r.anno}</strong></td><td>${r.campo}</td>
    <td>${fd(r.dataInizio)}</td><td>${fd(r.dataFine)}</td>
    <td>${r.kg?r.kg+' kg':'‚Äî'}</td><td>${r.kgHa?r.kgHa+' kg/ha':'‚Äî'}</td>
    <td>${r.destinazione||'‚Äî'}</td>
    <td style="max-width:140px">${r.note||'‚Äî'}</td>
    <td><div class="act"><button class="btn-ic" onclick="editRacc(${r.id})">‚úèÔ∏è</button><button class="btn-ic" onclick="delRacc(${r.id})">üóëÔ∏è</button></div></td></tr>`).join('');
}

function openRaccModal(r) {
  sv({'r-id':r?.id||'','r-anno':r?.anno||new Date().getFullYear(),'r-campo':r?.campo||'',
    'r-ini':r?.dataInizio||'','r-fin':r?.dataFine||'','r-kg':r?.kg||'',
    'r-kgha':r?.kgHa||'','r-dest':r?.destinazione||'','r-note':r?.note||''});
  document.getElementById('mr-title').textContent = r ? 'Modifica Raccolta' : 'Nuova Raccolta';
  om('m-racc');
}
function editRacc(id) { openRaccModal(S.racc.find(r=>r.id===id)); }

async function saveRacc() {
  if (!gv('r-anno')||!gv('r-campo')) { toast('Compila i campi obbligatori'); return; }
  await api('saveRaccolta', { data: { id:gv('r-id')?+gv('r-id'):null, anno:gv('r-anno'), campo:gv('r-campo'),
    dataInizio:gv('r-ini'), dataFine:gv('r-fin'), kg:gv('r-kg'),
    kgHa:gv('r-kgha'), destinazione:gv('r-dest'), note:gv('r-note') }});
  cm('m-racc'); loadRacc(); toast('Raccolta salvata!');
}

async function delRacc(id) {
  if (!confirm('Eliminare questa raccolta?')) return;
  await api('deleteRaccolta', { rowId: id });
  loadRacc(); toast('Eliminata');
}

// ============================================================
// OVERVIEW
// ============================================================
const CAT_COLORS = {
  'Prodotti Fitosanitari':'#ef4444','Concimi / Fertilizzanti':'#22c55e',
  'Carburante':'#f97316','Manodopera':'#3b82f6',
  'Affitto':'#8b5cf6','Macchinari / Attrezzature':'#06b6d4','Altro':'#94a3b8'
};
const CAMPO_COLORS = ['#2d6a4f','#52b788','#95d5b2','#40916c','#74c69d','#1b4332','#b7e4c7'];

async function loadOverview() {
  document.getElementById('ov-cards').innerHTML = '<div class="spin-wrap"><div class="spinner"></div>Caricamento...</div>';
  document.getElementById('ov-stats').innerHTML = '';
  document.getElementById('ov-charts').innerHTML = '';
  const data = await api('getOverview');
  renderOverview(data);
}

function renderOverview(data) {
  const anno = new Date().getFullYear();
  const campi = data.campi || [];
  const tEtt = campi.reduce((s,c)=>s+(parseFloat(c.ettari)||0),0);
  const tCos = campi.reduce((s,c)=>s+(parseFloat(c.costiAnno)||0),0);
  const tEnt = data.entrateAnno || 0;
  const rr = data.raccoltaRiepilogo;
  const costiCat = data.costiPerCategoria || [];

  // Stat bar
  document.getElementById('ov-stats').innerHTML = `
    <div class="sc"><div class="sc-lbl">Campi</div><div class="sc-val">${campi.length}</div></div>
    <div class="sc blue"><div class="sc-lbl">Ettari Totali</div><div class="sc-val">${tEtt.toFixed(1)}</div></div>
    <div class="sc amber"><div class="sc-lbl">Costi ${anno}</div><div class="sc-val">${fe(tCos)}</div></div>
    <div class="sc violet"><div class="sc-lbl">PAC / Bio ${anno}</div><div class="sc-val">${fe(tEnt)}</div></div>`;

  // Charts section
  const harvHtml = rr ? `
    <div class="harv-box">
      <div class="harv-totals">
        <div class="harv-stat"><div class="harv-lbl">Totale KG Olive</div><div class="harv-val">${rr.totKg.toLocaleString('it-IT')} kg</div></div>
        <div class="harv-stat"><div class="harv-lbl">Stima Olio (resa 15%)</div><div class="harv-val">~ ${rr.stimaOlio.toLocaleString('it-IT')} L</div></div>
      </div>
      <div class="harv-mini">
        ${rr.perCampo.sort((a,b)=>b.kg-a.kg).map((r,i)=>`
          <div class="harv-row">
            <span class="harv-campo">${r.campo}</span>
            <div class="harv-bar-wrap"><div class="harv-bar" style="width:${rr.totKg?Math.round(r.kg/rr.totKg*100):0}%;background:${CAMPO_COLORS[i%CAMPO_COLORS.length]}"></div></div>
            <span class="harv-kg">${r.kg} kg</span>
          </div>`).join('')}
      </div>
    </div>` : `<div class="empty" style="padding:24px 0"><div class="empty-ic">ü´ô</div><p>Nessuna raccolta registrata</p></div>`;

  document.getElementById('ov-charts').innerHTML = `
    <div class="ov-charts">
      <div class="chart-box">
        <h4>Costi per categoria ‚Äî ${anno}</h4>
        <div class="pie-wrap">
          <canvas id="pie-costi" width="130" height="130"></canvas>
          <div class="pie-legend" id="pie-costi-leg"></div>
        </div>
      </div>
      <div class="chart-box">
        <h4>Ultima raccolta${rr?' ‚Äî '+rr.anno:''}</h4>
        ${harvHtml}
      </div>
    </div>`;

  requestAnimationFrame(() => {
    const pieItems = costiCat.map(c=>({ label:c.categoria, value:c.totale, color:CAT_COLORS[c.categoria]||'#94a3b8' }));
    const totPie = pieItems.reduce((s,i)=>s+i.value,0);
    drawPie('pie-costi', pieItems);
    pieLegend('pie-costi-leg', pieItems, totPie);
  });

  // Campo cards
  if (!campi.length) {
    document.getElementById('ov-cards').innerHTML = `<div style="grid-column:1/-1"><div class="empty"><div class="empty-ic">ü´í</div><p>Nessun campo. Vai in <strong>Campi</strong> e aggiungine uno.</p></div></div>`;
    return;
  }
  document.getElementById('ov-cards').innerHTML = campi.map(c=>`
    <div class="card">
      <div class="card-name">ü´í ${c.nome}</div>
      <div class="card-sub">${[c.varieta,c.comune].filter(Boolean).join(' ¬∑ ')||'‚Äî'}</div>
      <div class="metrics">
        <div class="metric"><div class="ml">Ettari</div><div class="mv">${c.ettari||'‚Äî'}</div></div>
        <div class="metric"><div class="ml">N. Piante</div><div class="mv">${c.numPiante||'‚Äî'}</div></div>
        <div class="metric"><div class="ml">Costi ${anno}</div><div class="mv">${c.costiAnno>0?fe(c.costiAnno):'‚Äî'}</div></div>
        <div class="metric"><div class="ml">Ultimo Raccolto</div><div class="mv">${c.ultimaRaccolta?c.ultimaRaccolta.kg+' kg ('+c.ultimaRaccolta.anno+')':'‚Äî'}</div></div>
      </div>
      <div class="interventi">
        ${ir('Potatura', c.ultimaPotatura, 365)}
        ${ir('Trattamento', c.ultimoTrattamento, 90)}
        ${ir('Concimazione', c.ultimaConcimazione, 180)}
      </div>
    </div>`).join('');
}

function ir(lbl, data, soglia) {
  if (!data) return `<div class="irow"><span class="ilbl">${lbl}</span><span class="idate na">Mai registrata</span></div>`;
  const d = Math.floor((new Date()-new Date(data))/864e5);
  const cls = d>soglia?'old':d>soglia*.8?'warn':'ok';
  return `<div class="irow"><span class="ilbl">${lbl}</span><span class="idate ${cls}">${fd(data)} ¬∑ ${d}gg fa</span></div>`;
}

function drawPie(canvasId, items) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height, cx = W/2, cy = H/2, r = Math.min(W,H)/2 - 3;
  ctx.clearRect(0,0,W,H);
  const total = items.reduce((s,it)=>s+it.value,0);
  if (!total) {
    ctx.fillStyle='#e9ede9'; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#94a3b8'; ctx.font='11px Inter,sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('Nessun dato',cx,cy); return;
  }
  let angle = -Math.PI/2;
  items.forEach(it => {
    const slice = (it.value/total)*Math.PI*2;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,angle,angle+slice); ctx.closePath();
    ctx.fillStyle=it.color; ctx.fill(); ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.stroke();
    angle += slice;
  });
  // Donut hole
  ctx.beginPath(); ctx.arc(cx,cy,r*0.42,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
}

function pieLegend(containerId, items, total) {
  const el = document.getElementById(containerId);
  if (!el) return;
  el.innerHTML = items.filter(it=>it.value>0).map(it=>`
    <div class="pie-leg-it">
      <span class="pie-dot" style="background:${it.color}"></span>
      <span class="pie-name">${it.label}</span>
      <span class="pie-pct">${Math.round(it.value/total*100)}%</span>
      <span class="pie-eur">${fe(it.value)}</span>
    </div>`).join('');
}

// ============================================================
// ENTRATE PAC / BIOLOGICO
// ============================================================
async function loadEntrate() {
  S.entrate = await api('getEntrate');
  renderEntrate();
  updateAnniSelect();
}

function renderEntrate() {
  const tb = document.getElementById('entrate-tb');
  const fa = gv('ef-anno'), ft = gv('ef-tipo');
  let d = S.entrate.filter(e=>(!fa||+e.anno===+fa)&&(!ft||e.tipo===ft)).sort((a,b)=>b.anno-a.anno);
  const tot = d.reduce((s,e)=>s+(parseFloat(e.importo)||0),0);
  document.getElementById('entrate-tot').textContent = d.length ? 'Totale: '+fe(tot) : '';
  if (!d.length) { tb.innerHTML = er(7,'üí∂','Nessuna entrata registrata.'); return; }
  tb.innerHTML = d.map(e=>`<tr>
    <td><strong>${e.anno}</strong></td><td>${e.campo||'‚Äî'}</td>
    <td><span class="badge ${e.tipo==='PAC'?'bb':e.tipo==='Biologico'?'bg':'bgr'}">${e.tipo}</span></td>
    <td>${e.descrizione||'‚Äî'}</td>
    <td><strong>${e.importo?fe(e.importo):'‚Äî'}</strong></td>
    <td style="max-width:140px">${e.note||'‚Äî'}</td>
    <td><div class="act"><button class="btn-ic" onclick="editEntrata(${e.id})">‚úèÔ∏è</button><button class="btn-ic" onclick="delEntrata(${e.id})">üóëÔ∏è</button></div></td></tr>`).join('');
}

function updateAnniSelect() {
  const el = document.getElementById('ef-anno');
  if (!el) return;
  const anni = [...new Set(S.entrate.map(e=>e.anno))].sort((a,b)=>b-a);
  const cur = el.value;
  el.innerHTML = '<option value="">Tutti gli anni</option>' + anni.map(a=>`<option value="${a}">${a}</option>`).join('');
  el.value = cur;
}

function openEntrataModal(e) {
  sv({'e-id':e?.id||'','e-anno':e?.anno||new Date().getFullYear(),'e-campo':e?.campo||'',
    'e-tipo':e?.tipo||'','e-desc':e?.descrizione||'','e-importo':e?.importo||'','e-note':e?.note||''});
  document.getElementById('me-title').textContent = e ? 'Modifica Entrata' : 'Nuova Entrata';
  om('m-entrata');
}
function editEntrata(id) { openEntrataModal(S.entrate.find(e=>e.id===id)); }

async function saveEntrata() {
  if (!gv('e-anno')||!gv('e-tipo')) { toast('Compila i campi obbligatori'); return; }
  await api('saveEntrata', { data: { id:gv('e-id')?+gv('e-id'):null, anno:gv('e-anno'), campo:gv('e-campo'),
    tipo:gv('e-tipo'), descrizione:gv('e-desc'), importo:gv('e-importo'), note:gv('e-note') }});
  cm('m-entrata'); loadEntrate(); toast('Entrata salvata!');
}

async function delEntrata(id) {
  if (!confirm('Eliminare questa entrata?')) return;
  await api('deleteEntrata', { rowId: id });
  loadEntrate(); toast('Eliminata');
}

// ============================================================
// DIARI CAMPO ‚Äî appunti foto + voce + GPS
// ============================================================

// POST per upload foto (GAS doPost)
async function apiPost(payload) {
  try {
    const res = await fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ token: TOKEN, ...payload }),
      redirect: 'follow'
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    return data;
  } catch(e) { toast('Errore: ' + e.message); throw e; }
}

// Ridimensiona immagine lato browser (max 1200px, JPEG 0.75)
async function resizeImage(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        let w = img.width, h = img.height;
        const max = 1200;
        if (w > max || h > max) { const r = Math.min(max/w, max/h); w = Math.round(w*r); h = Math.round(h*r); }
        const c = document.createElement('canvas');
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(c.toDataURL('image/jpeg', 0.75));
      };
      img.onerror = reject;
      img.src = ev.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// GPS
let _gps = null;
function getLocation() {
  const el = document.getElementById('ap-gps-info');
  if (!navigator.geolocation) { if(el) { el.textContent='GPS non disponibile'; el.style.color='#94a3b8'; } return; }
  navigator.geolocation.getCurrentPosition(
    pos => {
      _gps = { lat: pos.coords.latitude.toFixed(6), lon: pos.coords.longitude.toFixed(6) };
      if (el) { el.innerHTML = `üìç <a href="https://maps.google.com/?q=${_gps.lat},${_gps.lon}" target="_blank" style="color:#16a34a">${_gps.lat}, ${_gps.lon}</a>`; }
    },
    () => { _gps = null; if(el) { el.textContent='üìç Posizione non disponibile'; el.style.color='#94a3b8'; } },
    { timeout: 12000, enableHighAccuracy: true }
  );
}

// Voce ‚Üí testo (Web Speech API, iOS Safari + Chrome Android)
let _rec = null, _isRec = false;
function toggleVoice() { _isRec ? stopVoice() : startVoice(); }
function startVoice() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { toast('Trascrizione vocale non supportata su questo browser'); return; }
  _isRec = true;
  _rec = new SR();
  _rec.lang = 'it-IT';
  _rec.continuous = false;
  _rec.interimResults = true;
  _rec.onresult = e => {
    const t = Array.from(e.results).map(r => r[0].transcript).join('');
    document.getElementById('ap-testo').value = t;
  };
  _rec.onend = () => { if (_isRec) { try { _rec.start(); } catch(_){} } };
  _rec.onerror = () => { _isRec = false; updateMicBtn(false); };
  _rec.start();
  updateMicBtn(true);
}
function stopVoice() { _isRec = false; if (_rec) { _rec.stop(); _rec = null; } updateMicBtn(false); }
function updateMicBtn(on) {
  const btn = document.getElementById('mic-btn');
  if (!btn) return;
  btn.className = 'mic-btn' + (on ? ' recording' : '');
  btn.textContent = on ? 'üî¥ Parla... (tocca per fermare)' : 'üéôÔ∏è Tocca per dettare';
}

// Foto
let _photoData = null;
async function onPhotoSelected(input) {
  const file = input.files[0];
  if (!file) return;
  try {
    _photoData = await resizeImage(file);
    const prev = document.getElementById('ap-photo-preview');
    prev.src = _photoData;
    prev.style.display = 'block';
    document.getElementById('ap-photo-placeholder').style.display = 'none';
  } catch(_) { toast('Errore caricamento foto'); }
}

// Apri / chiudi modal capture
function openCapture() {
  _photoData = null; _gps = null;
  stopVoice();
  document.getElementById('ap-photo-preview').style.display = 'none';
  document.getElementById('ap-photo-placeholder').style.display = '';
  document.getElementById('ap-file').value = '';
  document.getElementById('ap-testo').value = '';
  document.getElementById('ap-campo').value = '';
  const gpsEl = document.getElementById('ap-gps-info');
  gpsEl.textContent = 'üìç Acquisendo posizione...'; gpsEl.style.color = 'var(--muted)';
  updateMicBtn(false);
  om('m-appunto');
  getLocation();
}
function closeCapture() { stopVoice(); cm('m-appunto'); }

// Salva appunto (POST con eventuale foto base64)
async function saveAppunto() {
  if (!gv('ap-campo')) { toast('Seleziona il campo'); return; }
  const btn = document.getElementById('ap-save-btn');
  btn.disabled = true; btn.textContent = 'Salvataggio...';
  try {
    await apiPost({ action: 'saveAppunto', data: {
      campo: gv('ap-campo'), testo: gv('ap-testo'),
      lat: _gps?.lat || '', lon: _gps?.lon || '',
      foto: _photoData || null
    }});
    closeCapture(); loadAppunti(); toast('Appunto salvato!');
  } catch(_) {}
  finally { btn.disabled = false; btn.textContent = 'Salva'; }
}

// Lista appunti
async function loadAppunti() {
  document.getElementById('ap-grid').innerHTML = '<div class="spin-wrap"><div class="spinner"></div>Caricamento...</div>';
  S.appunti = await api('getAppunti');
  renderAppunti();
}

function renderAppunti() {
  const grid = document.getElementById('ap-grid');
  const fc = gv('apf-campo');
  const d = S.appunti.filter(a => !fc || a.campo === fc).sort((a,b) => new Date(b.data) - new Date(a.data));
  if (!d.length) {
    grid.innerHTML = '<div style="grid-column:1/-1"><div class="empty"><div class="empty-ic">üì∑</div><p>Nessun appunto. Dal campo, clicca <strong>Nuovo Appunto</strong>.</p></div></div>';
    return;
  }
  grid.innerHTML = d.map(a => `
    <div class="ap-card">
      ${a.fotoUrl ? `<img class="ap-photo" src="${a.fotoUrl}" loading="lazy" alt="foto campo">` : '<div class="ap-photo-ph">üì∑</div>'}
      <div class="ap-body">
        <div class="ap-meta">
          <span class="ap-campo">ü´í ${a.campo}</span>
          <span class="ap-date">${fdh(a.data)}</span>
        </div>
        ${a.testo ? `<div class="ap-text">${a.testo}</div>` : ''}
        ${a.lat && a.lon ? `<a class="ap-gps" href="https://maps.google.com/?q=${a.lat},${a.lon}" target="_blank">üìç Apri in Maps (${a.lat}, ${a.lon})</a>` : ''}
        <div class="ap-foot"><button class="btn-ic" onclick="delAppunto(${a.id})">üóëÔ∏è</button></div>
      </div>
    </div>`).join('');
}

async function delAppunto(id) {
  if (!confirm('Eliminare questo appunto?')) return;
  await api('deleteAppunto', { rowId: id });
  loadAppunti(); toast('Eliminato');
}

// ============================================================
// UTILS
// ============================================================
function updateSelects() {
  ['l-campo','co-campo','r-campo','e-campo','ap-campo','lf-campo','cf-campo','rf-campo','apf-campo'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const isF = id.includes('f-'), cur = el.value;
    el.innerHTML = isF ? '<option value="">Tutti i campi</option>' : '<option value="">Seleziona campo...</option>';
    S.campi.forEach(c => el.innerHTML += `<option value="${esc(c.nome)}">${c.nome}</option>`);
    el.value = cur;
  });
}

function toggleSidebar() {
  const open = document.querySelector('.sidebar').classList.toggle('open');
  document.getElementById('nav-overlay').classList.toggle('open', open);
}
function closeSidebar() {
  document.querySelector('.sidebar').classList.remove('open');
  document.getElementById('nav-overlay').classList.remove('open');
}
function om(id) { document.getElementById(id).classList.add('open'); }
function cm(id) { document.getElementById(id).classList.remove('open'); }
function gv(id) { return document.getElementById(id).value; }
function sv(m) { Object.entries(m).forEach(([id,v])=>{ const el=document.getElementById(id); if(el) el.value=v??''; }); }
function today() { return new Date().toISOString().split('T')[0]; }
function esc(s) { return String(s).replace(/"/g,'&quot;'); }
function fd(d) {
  if (!d) return '‚Äî';
  const dt = new Date(d);
  return isNaN(dt) ? d : dt.toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'});
}
function fdh(d) {
  if (!d) return '‚Äî';
  const dt = new Date(d);
  return isNaN(dt) ? d : dt.toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
}
function fe(n) { return '‚Ç¨\u00a0'+parseFloat(n).toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function er(cols, ic, msg) { return `<tr><td colspan="${cols}"><div class="empty"><div class="empty-ic">${ic}</div><p>${msg}</p></div></td></tr>`; }
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(t._t); t._t = setTimeout(()=>t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
